//@creator ethan-safar
//@date 05/01/2026
//@version=5
indicator("100x Explosive Breakout Scalping 5min", overlay=true, max_labels_count=500)

// â”â”â”â”â”â”â”â”â”â”â”â”â” INPUTS â”â”â”â”â”â”â”â”â”â”â”â”â”
// Breakout Detection
bbLength    = input.int(20, "BB Length", minval=10)
bbMult      = input.float(2.0, "BB Multiplier", minval=1.0, step=0.1)
compressionThreshold = input.float(2.5, "Compression % (BB squeeze)", minval=1.0, step=0.5)

// Momentum
rsiLen      = input.int(14, "RSI Length", minval=5)
rsiBreakout = input.int(55, "RSI Breakout Level", minval=50, maxval=70)
macdFast    = input.int(12, "MACD Fast", minval=5)
macdSlow    = input.int(26, "MACD Slow", minval=10)
macdSig     = input.int(9, "MACD Signal", minval=5)

// Volume
volumeExplosion = input.float(2.0, "Volume Explosion (x avg)", minval=1.5, step=0.5)

// Risk Management (Momentum-based exit)
stopLossPct = input.float(1.0, "Stop Loss %", minval=0.5, maxval=2.0, step=0.1)
minProfitPct = input.float(0.8, "Min Profit to Exit %", minval=0.3, step=0.1)  // Must be in profit before momentum exit
useMomentumExit = input.bool(true, "Use Momentum Exit (recommended)")
useFixedTP = input.bool(false, "Use Fixed TP (not recommended)")
fixedTPPct = input.float(5.0, "Fixed TP % (if enabled)", minval=2.0, step=0.5)

// Position
positionUsd = input.float(10000.0, "Position ($)", minval=100.0, step=100.0)
leverage    = input.int(100, "Leverage", minval=1, maxval=125)

// Visuals
showLabels = input.bool(true, "Show Labels")
showLevels = input.bool(true, "Show Levels")

// â”â”â”â”â”â”â”â”â”â”â”â”â” INDICATORS â”â”â”â”â”â”â”â”â”â”â”â”â”
// Bollinger Bands
[bbMiddle, bbUpper, bbLower] = ta.bb(close, bbLength, bbMult)
bbWidth = ((bbUpper - bbLower) / bbMiddle) * 100

// RSI
rsi = ta.rsi(close, rsiLen)

// MACD
[macdLine, signalLine, macdHist] = ta.macd(close, macdFast, macdSlow, macdSig)

// EMAs
ema20 = ta.ema(close, 20)
ema50 = ta.ema(close, 50)

// Volume
volAvg = ta.sma(volume, 20)
volExplosive = volume >= (volAvg * volumeExplosion)

// ATR
atr = ta.atr(14)

// â”â”â”â”â”â”â”â”â”â”â”â”â” BREAKOUT DETECTION â”â”â”â”â”â”â”â”â”â”â”â”â”
// 1. Compression phase (BB squeeze) - VolatilitÃ© faible = explosion imminente
isCompressed = bbWidth < compressionThreshold

// 2. Breakout au-dessus de BB middle avec force
priceBreakout = ta.crossover(close, bbMiddle) or (close > bbMiddle and close[1] <= bbMiddle)

// 3. Volume explosion - Money flowing in
volumeConfirm = volExplosive

// 4. RSI showing strength but not overbought yet
rsiStrength = rsi > rsiBreakout and rsi < 75

// 5. MACD momentum turning bullish FAST
macdMomentum = macdHist > 0 and macdHist > macdHist[1] and macdLine > signalLine

// 6. Price above EMA20 (short-term trend)
trendOk = close > ema20

// â”â”â”â”â”â”â”â”â”â”â”â”â” ENTRY SIGNAL (The Explosive Setup) â”â”â”â”â”â”â”â”â”â”â”â”â”
// Confluence of ALL conditions = HIGH probability explosive move
buySig = priceBreakout and volumeConfirm and rsiStrength and macdMomentum and trendOk

// Alternative: Catching the rocket mid-flight (less strict)
buyAggressive = volExplosive and (close > close[1] * 1.005) and macdMomentum and rsiStrength

// â”â”â”â”â”â”â”â”â”â”â”â”â” TRADE MANAGEMENT (Momentum-based) â”â”â”â”â”â”â”â”â”â”â”â”â”
var bool inTrade = false
var float entryPrice = na
var float stopLoss = na
var float fixedTP = na
var float highestPrice = na
var int barsInTrade = 0
var float liqPrice = na

// ENTRY
if buySig and not inTrade
    inTrade := true
    entryPrice := close
    stopLoss := close * (1 - stopLossPct / 100)
    fixedTP := useFixedTP ? close * (1 + fixedTPPct / 100) : na
    highestPrice := close
    barsInTrade := 0
    // Calculate liquidation price for long position
    // Liq = Entry * (1 - 1/Leverage * (1 - maintenance_margin))
    // Using 0.5% maintenance margin for simplicity
    liqPrice := close * (1 - 1 / leverage * (1 - 0.005))

// Update during trade
if inTrade
    barsInTrade := barsInTrade + 1
    if close > highestPrice
        highestPrice := close

// â”â”â”â”â”â”â”â”â”â”â”â”â” EXIT LOGIC (Momentum-based) â”â”â”â”â”â”â”â”â”â”â”â”â”
// Calculate current profit
currentProfitPct = inTrade and not na(entryPrice) ? ((close - entryPrice) / entryPrice * 100) : 0

// Basic exits
hitStopLoss = inTrade and (low <= stopLoss)
hitFixedTP = inTrade and useFixedTP and not na(fixedTP) and (high >= fixedTP)
hitLiquidation = inTrade and not na(liqPrice) and (low <= liqPrice)

// â”â”â”â” MOMENTUM EXIT SIGNALS (the smart part) â”â”â”â”
// 1. MACD momentum weakening
macdWeakening = macdHist < macdHist[1] and macdHist[1] < macdHist[2]  // 2 bars of declining momentum

// 2. Price breaks below EMA20 (lost short-term support)
lostEMA20Support = ta.crossunder(close, ema20) or (close < ema20 and close[1] >= ema20)

// 3. RSI Divergence (price higher but RSI lower = weakness)
rsiDivergence = (close > close[1]) and (rsi < rsi[1]) and (rsi < rsi[2])

// 4. Volume drying up (no more buyers)
volumeDrying = volume < volAvg * 0.7  // Volume dropped significantly

// 5. Strong red candle (reversal signal)
strongRedCandle = (close < open) and ((open - close) > atr * 0.5)

// 6. RSI overbought + turning down
rsiOverboughtTurn = (rsi > 70) and (rsi < rsi[1])

// Combine momentum exit signals (any of these = exit if profitable)
momentumExitSignal = useMomentumExit and (currentProfitPct >= minProfitPct) and (macdWeakening or lostEMA20Support or rsiDivergence or  (volumeDrying and barsInTrade > 3) or strongRedCandle or rsiOverboughtTurn)

// FINAL SELL DECISION
sellSig = inTrade and (hitStopLoss or hitFixedTP or momentumExitSignal or hitLiquidation)

// Determine exit details
var string exitReason = ""
var float exitPrice = na

if sellSig
    if hitLiquidation
        exitPrice := liqPrice
        exitReason := "ğŸ’€ LIQUIDATION"
    else if hitStopLoss
        exitPrice := stopLoss
        exitReason := "ğŸ›‘ STOP LOSS"
    else if hitFixedTP
        exitPrice := fixedTP
        exitReason := "ğŸ¯ FIXED TP"
    else if macdWeakening
        exitPrice := close
        exitReason := "ğŸ“‰ MACD WEAKENING"
    else if lostEMA20Support
        exitPrice := close
        exitReason := "âš ï¸ LOST EMA20"
    else if rsiDivergence
        exitPrice := close
        exitReason := "ğŸ”» RSI DIVERGENCE"
    else if volumeDrying
        exitPrice := close
        exitReason := "ï¿½ VOLUME DRYING"
    else if strongRedCandle
        exitPrice := close
        exitReason := "ğŸ”´ RED CANDLE"
    else if rsiOverboughtTurn
        exitPrice := close
        exitReason := "ï¿½ RSI OVERBOUGHT"
    else
        exitPrice := close
        exitReason := "ğŸšª MOMENTUM EXIT"
    
    // Reset trade state
    inTrade := false
    entryPrice := na
    stopLoss := na
    fixedTP := na
    highestPrice := na
    barsInTrade := 0

// â”â”â”â”â”â”â”â”â”â”â”â”â” PnL CALCULATION â”â”â”â”â”â”â”â”â”â”â”â”â”
notionalUsd = positionUsd * leverage

var float pnlUsd = na
var float pnlPct = na
var float roiPct = na

if sellSig and not na(entryPrice) and not na(exitPrice)
    pnlPct := ((exitPrice - entryPrice) / entryPrice) * 100
    pnlUsd := notionalUsd * pnlPct / 100
    roiPct := (pnlUsd / positionUsd) * 100

// â”â”â”â”â”â”â”â”â”â”â”â”â” VISUAL PLOTS â”â”â”â”â”â”â”â”â”â”â”â”â”
// EMAs
plot(ema20, "EMA 20", color=color.new(color.blue, 0), linewidth=2)
plot(ema50, "EMA 50", color=color.new(color.orange, 50), linewidth=1)

// Bollinger Bands
p1 = plot(bbUpper, "BB Upper", color=color.new(color.purple, 70))
p2 = plot(bbLower, "BB Lower", color=color.new(color.purple, 70))
plot(bbMiddle, "BB Middle", color=color.new(color.purple, 80), style=plot.style_circles)
fill(p1, p2, color=color.new(color.purple, 95), title="BB Fill")

// Trade Levels
plot(showLevels and inTrade and not na(stopLoss) ? stopLoss : na, 
     "Stop Loss", color=color.new(color.red, 0), linewidth=3, style=plot.style_linebr)
plot(showLevels and inTrade and not na(liqPrice) ? liqPrice : na, 
     "Liquidation", color=color.new(color.maroon, 0), linewidth=2, style=plot.style_linebr)
plot(showLevels and inTrade and useFixedTP and not na(fixedTP) ? fixedTP : na, 
     "Fixed TP", color=color.new(#55ffc6, 0), linewidth=2, style=plot.style_linebr)
plot(showLevels and inTrade ? entryPrice : na, 
     "Entry", color=color.new(color.white, 50), linewidth=1, style=plot.style_circles)

// â”â”â”â”â”â”â”â”â”â”â”â”â” LABELS â”â”â”â”â”â”â”â”â”â”â”â”â”
// Create/update label for current or completed trade
var label tradeLabel = na

if buySig and showLabels and not na(stopLoss)
    // Create new label on entry
    labelText = "ğŸš€ LONG x" + str.tostring(leverage) + "\n" + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + "Entry: $" + str.tostring(entryPrice, "#.##") + "\n" + "Stop: $" + str.tostring(stopLoss, "#.##") + "\n" + "Liq: $" + str.tostring(liqPrice, "#.##") + "\n" + "Exit: PENDING\n" + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + "PnL: $0.00\n" + "Status: IN TRADE"
    
    tradeLabel := label.new(bar_index, low * 0.999, labelText, style=label.style_label_up, color=color.new(#2195f3, 90), textcolor=color.white, size=size.normal,textalign=text.align_left)

// Update label while in trade (show current unrealized PnL)
if inTrade and not na(tradeLabel) and not na(entryPrice)
    unrealizedPnl = notionalUsd * ((close - entryPrice) / entryPrice)
    
    labelText = "ğŸš€ LONG x" + str.tostring(leverage) + "\n" + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + "Entry: $" + str.tostring(entryPrice, "#.##") + "\n" + "Stop: $" + str.tostring(stopLoss, "#.##") + "\n" + "Liq: $" + str.tostring(liqPrice, "#.##") + "\n" + "Current: $" + str.tostring(close, "#.##") + "\n" + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + "PnL: $" + str.tostring(unrealizedPnl, "#,###.##") + "\n" + "Status: IN TRADE"
    
    label.set_text(tradeLabel, labelText)
    label.set_x(tradeLabel, bar_index)
    label.set_y(tradeLabel, low * 0.999)

// Final update on exit
if sellSig and not na(tradeLabel) and not na(entryPrice) and not na(exitPrice)
    // Determine if win, lose, or liquidation
    isLiquidated = hitLiquidation
    isWin = pnlUsd > 0
    
    var string resultText = ""
    var color labelColor = color.blue
    
    if isLiquidated
        resultText := "ğŸ’€ LIQUIDATED"
        labelColor := color.maroon
    else if isWin
        resultText := "âœ… WIN"
        labelColor := color.green
    else
        resultText := "âŒ LOSE"
        labelColor := color.red
    
    labelText = "ğŸš€ LONG x" + str.tostring(leverage) + "\n" + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + "Entry: $" + str.tostring(entryPrice, "#.##") + "\n" + "Stop: $" + str.tostring(stopLoss, "#.##") + "\n" + "Liq: $" + str.tostring(liqPrice, "#.##") + "\n" + "Exit: $" + str.tostring(exitPrice, "#.##") + "\n" + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + "PnL: $" + str.tostring(pnlUsd, "#,###.##") + "\n" + "Status: " + resultText
    
    label.set_text(tradeLabel, labelText)
    label.set_color(tradeLabel, color.new(labelColor, 0))
    label.set_x(tradeLabel, bar_index)
    label.set_y(tradeLabel, low * 0.999)
    
    // Reset for next trade
    tradeLabel := na

// â”â”â”â”â”â”â”â”â”â”â”â”â” VISUAL SIGNALS â”â”â”â”â”â”â”â”â”â”â”â”â”
// Entry markers
plotshape(buySig, title="BUY SIGNAL", style=shape.triangleup, location=location.belowbar, color=color.new(color.lime, 0), size=size.normal, text="BUY")

// Exit markers
plotshape(sellSig and not hitStopLoss and not hitLiquidation, title="MOMENTUM EXIT", style=shape.flag, location=location.abovebar, color=color.new(color.green, 0), size=size.normal, text="EXIT")
          
plotshape(sellSig and hitStopLoss and not hitLiquidation, title="STOP LOSS", style=shape.xcross, location=location.abovebar, color=color.new(color.red, 0), size=size.normal, text="SL")

plotshape(sellSig and hitLiquidation, title="LIQUIDATION", style=shape.xcross, location=location.abovebar, color=color.new(color.maroon, 0), size=size.large, text="LIQ")

// Alert conditions for compression (pre-breakout alert)
alertcondition(isCompressed and volExplosive, "âš¡ Potential Breakout", "Compression + Volume spike detected!")
alertcondition(buySig, "ğŸš€ BUY Signal", "Explosive breakout detected!")
alertcondition(sellSig, "ğŸ’° EXIT Signal", "Exit condition triggered!")

// Background coloring
bgcolor(inTrade ? color.new(#00ff08, 0) : na, title="In Trade")
bgcolor(isCompressed ? color.new(#ffeb3b, 100) : na, title="Compressed (Pre-Breakout)")
